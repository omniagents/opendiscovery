<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenDiscovery - OpenAgents Network Registry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .network-card {
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tag {
            display: inline-block;
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 0.2rem 0.5rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }
        .network-actions {
            display: flex;
            gap: 0.5rem;
        }
        #publishForm {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">OpenDiscovery</h1>
        <p class="lead mb-4">Discover and publish OpenAgents networks</p>
        
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="networks-tab" data-bs-toggle="tab" data-bs-target="#networks" type="button" role="tab" aria-controls="networks" aria-selected="true">Networks</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="publish-tab" data-bs-toggle="tab" data-bs-target="#publish" type="button" role="tab" aria-controls="publish" aria-selected="false">Publish Network</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="networks" role="tabpanel" aria-labelledby="networks-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Available Networks</h2>
                    <button class="btn btn-primary" id="refreshBtn">Refresh</button>
                </div>
                
                <div class="mb-3">
                    <input type="text" class="form-control" id="filterInput" placeholder="Filter by tag (comma separated)">
                </div>
                
                <div id="networksList" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="publish" role="tabpanel" aria-labelledby="publish-tab">
                <h2 class="mb-3">Publish a Network</h2>
                
                <form id="publishForm">
                    <div class="mb-3">
                        <label for="configFile" class="form-label">Network Configuration File (YAML or JSON)</label>
                        <input class="form-control" type="file" id="configFile" accept=".yaml,.yml,.json">
                    </div>
                    
                    <div class="mb-3">
                        <label for="configText" class="form-label">Or paste configuration here:</label>
                        <textarea class="form-control" id="configText" rows="10" placeholder="Paste YAML or JSON configuration here"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Publish Network</button>
                </form>
                
                <div id="publishResult" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API endpoints
        const API_BASE = '/apis';
        
        // DOM elements
        const networksList = document.getElementById('networksList');
        const refreshBtn = document.getElementById('refreshBtn');
        const filterInput = document.getElementById('filterInput');
        const publishForm = document.getElementById('publishForm');
        const configFile = document.getElementById('configFile');
        const configText = document.getElementById('configText');
        const publishResult = document.getElementById('publishResult');
        
        // Load networks
        async function loadNetworks(filterTags = '') {
            networksList.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            try {
                let url = `${API_BASE}/list_networks`;
                
                if (filterTags) {
                    const tags = filterTags.split(',').map(tag => tag.trim());
                    url += `?filter=${encodeURIComponent(JSON.stringify({ tags }))}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    displayNetworks(data.networks);
                } else {
                    networksList.innerHTML = `<div class="col-12 alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                networksList.innerHTML = `<div class="col-12 alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        // Display networks
        function displayNetworks(networks) {
            if (networks.length === 0) {
                networksList.innerHTML = `<div class="col-12 text-center py-5">No networks found</div>`;
                return;
            }
            
            let html = '';
            
            networks.forEach(network => {
                const profile = network.network_profile || {};
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card network-card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${profile.name || 'Unnamed Network'}</h5>
                                <p class="card-text">${profile.description || 'No description'}</p>
                                
                                <div class="mb-2">
                                    ${(profile.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <small class="text-muted">Capacity: ${profile.capacity || 'Unknown'}</small>
                                    <div class="network-actions">
                                        <button class="btn btn-sm btn-outline-primary heartbeat-btn" data-network="${profile.name}">Heartbeat</button>
                                        <button class="btn btn-sm btn-outline-danger unpublish-btn" data-network="${profile.name}">Unpublish</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            networksList.innerHTML = html;
            
            // Add event listeners to buttons
            document.querySelectorAll('.heartbeat-btn').forEach(btn => {
                btn.addEventListener('click', sendHeartbeat);
            });
            
            document.querySelectorAll('.unpublish-btn').forEach(btn => {
                btn.addEventListener('click', unpublishNetwork);
            });
        }
        
        // Send heartbeat
        async function sendHeartbeat(event) {
            const networkId = event.target.dataset.network;
            const btn = event.target;
            
            btn.disabled = true;
            btn.innerHTML = 'Sending...';
            
            try {
                const response = await fetch(`${API_BASE}/heartbeat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ network_id: networkId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    btn.innerHTML = 'Success!';
                    setTimeout(() => {
                        btn.innerHTML = 'Heartbeat';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    btn.innerHTML = 'Failed';
                    alert(`Error: ${data.error}`);
                    setTimeout(() => {
                        btn.innerHTML = 'Heartbeat';
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                btn.innerHTML = 'Failed';
                alert(`Error: ${error.message}`);
                setTimeout(() => {
                    btn.innerHTML = 'Heartbeat';
                    btn.disabled = false;
                }, 2000);
            }
        }
        
        // Unpublish network
        async function unpublishNetwork(event) {
            const networkId = event.target.dataset.network;
            
            if (!confirm(`Are you sure you want to unpublish ${networkId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/unpublish`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ network_id: networkId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Network ${networkId} unpublished successfully.`);
                    loadNetworks(filterInput.value);
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // Publish network
        async function publishNetwork(event) {
            event.preventDefault();
            
            let formData;
            let contentType;
            
            if (configFile.files.length > 0) {
                // Use file upload
                formData = new FormData();
                formData.append('config', configFile.files[0]);
                contentType = null; // Let the browser set it
            } else if (configText.value.trim()) {
                // Use text input
                formData = configText.value.trim();
                contentType = 'application/json';
            } else {
                alert('Please provide a configuration file or paste configuration text.');
                return;
            }
            
            publishResult.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/publish`, {
                    method: 'POST',
                    headers: contentType ? {
                        'Content-Type': contentType
                    } : undefined,
                    body: formData
                });
                
                const data = await response.json();
                
                publishResult.style.display = 'block';
                
                if (data.success) {
                    publishResult.className = 'alert alert-success';
                    publishResult.innerHTML = `Network ${data.network_id} published successfully.`;
                    publishForm.reset();
                } else {
                    publishResult.className = 'alert alert-danger';
                    publishResult.innerHTML = `Error: ${data.error}`;
                }
            } catch (error) {
                publishResult.style.display = 'block';
                publishResult.className = 'alert alert-danger';
                publishResult.innerHTML = `Error: ${error.message}`;
            }
        }
        
        // Event listeners
        refreshBtn.addEventListener('click', () => loadNetworks(filterInput.value));
        filterInput.addEventListener('keyup', event => {
            if (event.key === 'Enter') {
                loadNetworks(filterInput.value);
            }
        });
        publishForm.addEventListener('submit', publishNetwork);
        
        // Initial load
        loadNetworks();
    </script>
</body>
</html> 